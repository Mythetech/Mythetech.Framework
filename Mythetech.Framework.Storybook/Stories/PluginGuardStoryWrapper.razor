@using Mythetech.Framework.Infrastructure.Plugins
@using Mythetech.Framework.Storybook.Stories
@using Microsoft.AspNetCore.Components

@ChildContent

@code {
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public PluginScenario Scenario { get; set; }

    [Inject]
    protected PluginState PluginState { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var pluginId = StorybookPluginData.EnabledPluginInfo.Manifest.Id;
        var existingPlugin = PluginState.GetPlugin(pluginId);

        if (existingPlugin is not null)
        {
            await PluginState.RemovePluginAsync(pluginId);
        }

        switch (Scenario)
        {
            case PluginScenario.Enabled:
                var enabledPlugin = StorybookPluginData.EnabledPluginInfo;
                await PluginState.RegisterPluginAsync(enabledPlugin);
                await PluginState.EnablePluginAsync(pluginId);
                break;

            case PluginScenario.Disabled:
                var disabledPlugin = StorybookPluginData.DisabledPluginInfo;
                await PluginState.RegisterPluginAsync(disabledPlugin);
                await PluginState.DisablePluginAsync(pluginId);
                break;

            case PluginScenario.Deleted:
                break;
        }
    }
}

