@namespace SampleHost.Desktop
@using MudBlazor
@using Mythetech.Framework.Infrastructure.Files
@using Mythetech.Framework.Infrastructure.Plugins
@using Mythetech.Framework.Infrastructure.Plugins.Components
@using Mythetech.Framework.Infrastructure.Settings
@using SampleHost.Shared
@using SampleHost.Shared.Settings
@inherits LayoutComponentBase
@inject PluginState PluginState
@inject IPluginAssetLoader AssetLoader
@inject IShowFileService ShowFileService
@inject ISettingsProvider SettingsProvider
@inject IDialogService DialogService
@implements IDisposable

<MudLayout>
    <MudAppBar Elevation="1">
        <MudText Typo="Typo.h5" Class="ml-3">@_appSettings.AppTitle</MudText>
        <MudSpacer />

        <MudMenu Label="File" ListClass="pa-1" Class="rounded" ActivationEvent="MouseEvent.MouseOver" Dense="true">
            <MudMenuItem OnClick="@OpenPluginDirectory" Disabled="@(string.IsNullOrEmpty(PluginState.PluginDirectory))">
                Open Plugin Directory
            </MudMenuItem>
        </MudMenu>

        <!-- Standard Plugin Menu with nested plugin actions -->
        <StandardPluginMenu MenuText="Plugins"
                           ListClass="pa-1"
                           ItemClass="rounded"
                           ButtonClass="text-transform-none" />

        <ToolsMenu />

        <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Inherit" OnClick="OpenSettings" />
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" Elevation="2" Variant="DrawerVariant.Mini" OpenMiniOnHover="true">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6">Plugins</MudText>
        </MudDrawerHeader>
        <MudNavMenu>
            <MudNavLink Href="/" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>
            <MudNavLink Href="/plugins" Icon="@Icons.Material.Filled.Extension">Manage Plugins</MudNavLink>
        </MudNavMenu>
    </MudDrawer>

    <MudMainContent Class="d-flex" Style="height: calc(100vh - 64px);">
        <div class="flex-grow-1 pa-4" style="overflow: auto;">
            @Body
        </div>

        <!-- Plugin context panels rendered as a side bar -->
        @if (_appSettings.ShowContextPanel && PluginState.PluginsLoaded && PluginState.EnabledContextPanelComponentsMetadata.Any())
        {
            <MudPaper Width="@($"{_appSettings.ContextPanelWidth}px")" Elevation="0" Class="border-l" Style="overflow: auto;">
                @foreach (var panel in PluginState.EnabledContextPanelComponentsMetadata.ToList().OrderBy(p => p.Order))
                {
                    <PluginGuard PluginInfo="(PluginState.EnabledPlugins.FirstOrDefault(p => p.ContextPanelComponentsMetadata.Any(m => m.Title.Equals(panel.Title))))" Metadata="panel" ShowErrorDetails="true">
                        <DynamicComponent Type="@panel.ComponentType" />
                    </PluginGuard>
                    <MudDivider />
                }
            </MudPaper>
        }
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private bool _pluginLoadingStarted;
    private SampleAppSettings _appSettings = new();

    protected override void OnInitialized()
    {
        PluginState.StateChanged += OnPluginStateChanged;

        // Get the registered settings instance
        var settings = SettingsProvider.GetSettings<SampleAppSettings>();
        if (settings != null)
        {
            _appSettings = settings;
        }

        _drawerOpen = _appSettings.DrawerExpandedOnStart;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_pluginLoadingStarted && !PluginState.PluginsLoaded)
        {
            _pluginLoadingStarted = true;
            await InitializePluginsAsync();
        }
    }

    private async Task InitializePluginsAsync()
    {
        try
        {
            // Get custom plugin directory from settings if configured
            var pluginSettings = SettingsProvider.GetSettings<PluginSettings>();
            string? pluginDirectory = null;

            if (!string.IsNullOrWhiteSpace(pluginSettings?.CustomPluginDirectory)
                && Directory.Exists(pluginSettings.CustomPluginDirectory))
            {
                pluginDirectory = pluginSettings.CustomPluginDirectory;
            }

            await PluginState.InitializePluginsAsync(pluginDirectory);
            await PluginState.LoadStateAsync();
            await LoadAllPluginAssetsAsync();
        }
        catch
        {
            // Silently handle errors - plugin loading is optional
        }
    }

    private async Task LoadAllPluginAssetsAsync()
    {
        // Take a snapshot to avoid collection modification during enumeration
        var plugins = PluginState.EnabledPlugins.ToList();
        foreach (var plugin in plugins)
        {
            try
            {
                await AssetLoader.LoadPluginAssetsAsync(plugin);
            }
            catch
            {
                // Continue loading other plugins even if one fails
            }
        }
    }

    private async void OnPluginStateChanged(object? sender, EventArgs e)
    {
        // Reload assets when plugin state changes (e.g., plugin enabled/disabled)
        try
        {
            await LoadAllPluginAssetsAsync();
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            // Silently handle errors
        }
    }

    private async Task OpenPluginDirectory()
    {
        if (!string.IsNullOrEmpty(PluginState.PluginDirectory))
        {
            await ShowFileService.ShowFolderAsync(PluginState.PluginDirectory);
        }
    }

    private async Task OpenSettings()
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<SampleSettingsDialog>("Settings", options);
        await dialog.Result;

        // Refresh UI after settings dialog closes
        StateHasChanged();
    }

    public void Dispose()
    {
        PluginState.StateChanged -= OnPluginStateChanged;
    }
}
