@using MudBlazor
@using System.Reflection
@using Mythetech.Framework.Infrastructure.Settings
@inject ISettingsEditorRegistry EditorRegistry

<div class="mf-dynamic-setting-control">
    <div class="mf-setting-label-row">
        <MudText Class="mf-setting-label">@Attribute.Label</MudText>
        @if (!string.IsNullOrEmpty(Attribute.Description))
        {
            <MudText Typo="Typo.caption" Class="mud-text-secondary mf-setting-description">
                @Attribute.Description
            </MudText>
        }
    </div>

    <div class="mf-setting-control">
        @if (TryGetEditorType(out var editorType))
        {
            <DynamicComponent Type="@editorType" Parameters="@GetEditorParameters()" />
        }
        else
        {
            <MudText Color="Color.Warning">
                Unsupported setting type: @Property.PropertyType.Name
            </MudText>
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public SettingsBase Settings { get; set; } = default!;

    [Parameter, EditorRequired]
    public PropertyInfo Property { get; set; } = default!;

    [Parameter, EditorRequired]
    public SettingAttribute Attribute { get; set; } = default!;

    /// <summary>
    /// Callback when a setting value changes.
    /// </summary>
    [Parameter]
    public EventCallback OnValueChanged { get; set; }

    private bool TryGetEditorType(out Type? editorType)
    {
        // Check for exact type match first
        if (EditorRegistry.HasEditorForType(Property.PropertyType))
        {
            editorType = EditorRegistry.GetEditorForType(Property.PropertyType);
            return true;
        }

        // Check for enum (special case - base type)
        if (Property.PropertyType.IsEnum && EditorRegistry.HasEditorForType(typeof(Enum)))
        {
            editorType = EditorRegistry.GetEditorForType(typeof(Enum));
            return true;
        }

        editorType = null;
        return false;
    }

    private Dictionary<string, object> GetEditorParameters() => new()
    {
        ["Settings"] = Settings,
        ["Property"] = Property,
        ["Attribute"] = Attribute,
        ["OnValueChanged"] = OnValueChanged
    };
}
