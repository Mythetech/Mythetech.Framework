@using MudBlazor
@using Mythetech.Framework.Infrastructure.Secrets
@using Mythetech.Framework.Components.Badge
@using Mythetech.Framework.Components.Buttons
@using Mythetech.Framework.Components.Input
@inject SecretManagerState SecretManagerState
@implements IDisposable

<MudDialog>
    <DialogContent>
        <MudStack Spacing="4">
            <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h6">Secret Manager</MudText>
                @if (SecretManagerState.CurrentManager != null)
                {
                    <Badge Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
                        @SecretManagerState.CurrentManager.Name
                    </Badge>
                }
            </MudStack>

            @if (SecretManagerState.AvailableManagers.Count > 1)
            {
                <MudSelect T="string"
                           Value="@SecretManagerState.CurrentManager?.Name"
                           ValueChanged="OnManagerChanged"
                           Label="Active Manager"
                           Variant="Variant.Outlined"
                           Dense="true">
                    @foreach (var manager in SecretManagerState.AvailableManagers)
                    {
                        <MudSelectItem Value="@manager.Name">
                            @manager.Name
                            @if (SecretManagerState.CanSearch(manager))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary"> (supports listing)</MudText>
                            }
                            @if (SecretManagerState.CanWrite(manager))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary"> (supports writing)</MudText>
                            }
                        </MudSelectItem>
                    }
                </MudSelect>
            }

            <MudDivider />

            <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                @if (SecretManagerState.CanSearch())
                {
                    <Button Variant="Variant.Outlined"
                            Color="Color.Primary"
                            StartIcon="@Icons.Material.Filled.Refresh"
                            OnClick="RefreshSecrets"
                            Disabled="_isRefreshing"
                            Text="Refresh" />
                }

                <Button Variant="Variant.Outlined"
                        Color="Color.Info"
                        StartIcon="@Icons.Material.Filled.CheckCircle"
                        OnClick="TestConnection"
                        Disabled="_isTesting"
                        Text="Test Connection" />

                @if (SecretManagerState.CanWrite())
                {
                    <Button Variant="Variant.Outlined"
                            Color="Color.Success"
                            StartIcon="@Icons.Material.Filled.Add"
                            OnClick="ToggleAddSecretForm"
                            Disabled="_isSaving"
                            Text="Add Secret" />
                }

                <Button Variant="Variant.Outlined"
                        Color="Color.Secondary"
                        StartIcon="@Icons.Material.Filled.Key"
                        OnClick="ToggleGetSecretForm"
                        Disabled="_isGetting"
                        Text="Get Secret" />

                <MudSpacer />

                @if (SecretManagerState.CanSearch())
                {
                    <MudTextField
                        T="string"
                        Value="_searchTerm"
                                  ValueChanged="@OnSearchTermChanged"
                                  Placeholder="Search secrets..."
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true"
                                  Style="max-width: 300px;" />
                }
            </MudStack>

            @if (_showAddSecretForm)
            {
                <MudPaper Elevation="1" Class="pa-4">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.subtitle1">Add New Secret</MudText>
                        <MudTextField T="string"
                                      @bind-Value="_newSecretKey"
                                      Label="Key"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      Placeholder="e.g., api-key, db-password" />
                        <ProtectedTextField
                            Value="@_newSecretValue"
                            ValueChanged="@(v => _newSecretValue = v ?? string.Empty)"
                            Label="Value"
                            Dense="true" />
                        <MudStack Row Spacing="2" Justify="Justify.FlexEnd">
                            <Button Variant="Variant.Text"
                                    OnClick="CancelAddSecret"
                                    Text="Cancel" />
                            <Button Variant="Variant.Filled"
                                    Color="Color.Primary"
                                    OnClick="SaveSecret"
                                    Disabled="@(_isSaving || string.IsNullOrWhiteSpace(_newSecretKey) || string.IsNullOrWhiteSpace(_newSecretValue))">
                                <ChildContent>
                                    @if (_isSaving)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    }
                                    Save
                                </ChildContent>
                            </Button>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            }

            @if (_showGetSecretForm)
            {
                <MudPaper Elevation="1" Class="pa-4">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.subtitle1">Get Secret by Key</MudText>
                        <MudTextField T="string"
                                      @bind-Value="_getSecretKey"
                                      Label="Key"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      Placeholder="Enter the secret key" />
                        @if (_retrievedSecret != null)
                        {
                            <MudPaper Elevation="0" Class="pa-2" Style="background-color: var(--mud-palette-background-grey);">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.body2" Style="font-weight: 500;">@(_retrievedSecret.Name ?? _retrievedSecret.Key)</MudText>
                                    <ProtectedTextField
                                        Value="@_retrievedSecret.Value"
                                        ValueChanged="@(_ => {})"
                                        Label="Value"
                                        Dense="true" />
                                </MudStack>
                            </MudPaper>
                        }
                        <MudStack Row Spacing="2" Justify="Justify.FlexEnd">
                            <Button Variant="Variant.Text"
                                    OnClick="CancelGetSecret"
                                    Text="Cancel" />
                            <Button Variant="Variant.Filled"
                                    Color="Color.Primary"
                                    OnClick="GetSecret"
                                    Disabled="@(_isGetting || string.IsNullOrWhiteSpace(_getSecretKey))">
                                <ChildContent>
                                    @if (_isGetting)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    }
                                    Get
                                </ChildContent>
                            </Button>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            }
            
            @if (_isRefreshing || _isTesting)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            }
            
            @if (!string.IsNullOrEmpty(_statusMessage))
            {
                <MudAlert Severity="@_alertSeverity" Dense="true">@_statusMessage</MudAlert>
            }
            
            @if (!SecretManagerState.IsAvailable)
            {
                <MudAlert Severity="Severity.Warning" Dense="true">
                    No secret managers are registered.
                </MudAlert>
            }
            else if (!SecretManagerState.HasActiveManager)
            {
                <MudAlert Severity="Severity.Warning" Dense="true">
                    No secret manager is currently active. Select one from the dropdown above.
                </MudAlert>
            }
            else if (!SecretManagerState.CanSearch())
            {
                <MudAlert Severity="Severity.Info" Dense="true">
                    @SecretManagerState.CurrentManager?.Name does not support listing secrets.
                    Use "Test Connection" to verify it's working, then retrieve secrets by key.
                </MudAlert>
            }

            <MudDivider />

            @if (_filteredSecrets.Any())
            {
                <MudList T="Secret" Dense="true">
                    @foreach (var secret in _filteredSecrets)
                    {
                        <MudListItem T="Secret">
                            <MudStack Spacing="1">
                                <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.body1" Style="font-weight: 500;">
                                        @(secret.Name ?? secret.Key)
                                    </MudText>
                                    @if (!string.IsNullOrEmpty(secret.Category))
                                    {
                                        <Badge Size="Size.Small" Color="Color.Secondary" Variant="Variant.Text">
                                            @secret.Category
                                        </Badge>
                                    }
                                </MudStack>
                                
                                @if (!string.IsNullOrEmpty(secret.Description))
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        @secret.Description
                                    </MudText>
                                }
                                
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Key: @secret.Key
                                </MudText>
                                
                                @if (secret.Tags != null && secret.Tags.Length > 0)
                                {
                                    <MudStack Row Spacing="1">
                                        @foreach (var tag in secret.Tags)
                                        {
                                            <Badge Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
                                                @tag
                                            </Badge>
                                        }
                                    </MudStack>
                                }
                                
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Value: @(new string('*', Math.Min(secret.Value?.Length ?? 0, 20)))
                                </MudText>
                            </MudStack>
                        </MudListItem>
                        <MudDivider />
                    }
                </MudList>
            }
            else if (!_isRefreshing)
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                    @(string.IsNullOrWhiteSpace(_searchTerm) ? "No secrets loaded. Click \"Test Connection\" to connect and load secrets." : "No secrets match your search.")
                </MudText>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <Button Text="Close" OnClick="Close" Variant="Variant.Text" />
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    private string _searchTerm = string.Empty;
    private bool _isRefreshing;
    private bool _isTesting;
    private bool _isSaving;
    private bool _isGetting;
    private bool _showAddSecretForm;
    private bool _showGetSecretForm;
    private string _newSecretKey = string.Empty;
    private string _newSecretValue = string.Empty;
    private string _getSecretKey = string.Empty;
    private Secret? _retrievedSecret;
    private string? _statusMessage;
    private Severity _alertSeverity = Severity.Info;

    private IEnumerable<Secret> _filteredSecrets = [];

    protected override void OnInitialized()
    {
        SecretManagerState.StateChanged += OnStateChanged;
        LoadSecrets();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        // Don't auto-connect - user must select a manager and click Test Connection first
    }

    private void OnStateChanged(object? sender, EventArgs e)
    {
        InvokeAsync(() =>
        {
            LoadSecrets();
            StateHasChanged();
        }).ContinueWith(t =>
        {
            if (t.IsFaulted && t.Exception != null)
            {
                Console.Error.WriteLine($"Error in OnStateChanged: {t.Exception}");
            }
        }, TaskScheduler.Default);
    }

    private void OnManagerChanged(string managerName)
    {
        if (!string.IsNullOrEmpty(managerName))
        {
            SecretManagerState.SetActiveManager(managerName);
            _statusMessage = null;
            _searchTerm = string.Empty;
            // Clear secrets cache when switching managers - user must click Test Connection
            SecretManagerState.ClearSecrets();
            LoadSecrets();
        }
    }

    private void OnSearchTermChanged(string? newValue)
    {
        _searchTerm = newValue ?? string.Empty;
        LoadSecrets();
        StateHasChanged();
    }

    private void LoadSecrets()
    {
        if (string.IsNullOrWhiteSpace(_searchTerm))
        {
            _filteredSecrets = SecretManagerState.Secrets;
        }
        else
        {
            var term = _searchTerm.ToLowerInvariant();
            _filteredSecrets = SecretManagerState.Secrets.Where(s =>
                s.Key.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                (s.Name?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (s.Description?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (s.Tags?.Any(t => t.Contains(term, StringComparison.OrdinalIgnoreCase)) ?? false) ||
                (s.Category?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false)
            );
        }
    }

    private async Task RefreshSecrets()
    {
        if (!SecretManagerState.CanSearch())
        {
            _statusMessage = "This manager does not support listing secrets.";
            _alertSeverity = Severity.Warning;
            return;
        }

        _isRefreshing = true;
        _statusMessage = null;
        StateHasChanged();

        var result = await SecretManagerState.RefreshSecretsAsync();

        if (result.Success)
        {
            _statusMessage = $"Loaded {SecretManagerState.Secrets.Count} secret(s)";
            _alertSeverity = Severity.Success;
        }
        else
        {
            _statusMessage = result.ErrorMessage ?? "Failed to refresh secrets";
            _alertSeverity = GetSeverityForErrorKind(result.ErrorKind);
        }

        LoadSecrets();
        _isRefreshing = false;
        StateHasChanged();
    }

    private async Task TestConnection()
    {
        _isTesting = true;
        _statusMessage = null;
        StateHasChanged();

        if (SecretManagerState.CurrentManager == null)
        {
            _statusMessage = "No secret manager is active";
            _alertSeverity = Severity.Warning;
            _isTesting = false;
            StateHasChanged();
            return;
        }

        var result = await SecretManagerState.CurrentManager.TestConnectionAsync();

        if (result.Success)
        {
            _statusMessage = $"{SecretManagerState.CurrentManager.Name}: Connection successful";
            _alertSeverity = Severity.Success;

            // After successful connection, refresh secrets if manager supports it
            if (SecretManagerState.CanSearch())
            {
                _isTesting = false;
                StateHasChanged();
                await RefreshSecrets();
                return;
            }
        }
        else
        {
            _statusMessage = result.ErrorMessage ?? "Connection test failed";
            _alertSeverity = GetSeverityForErrorKind(result.ErrorKind);
        }

        _isTesting = false;
        StateHasChanged();
    }

    private static Severity GetSeverityForErrorKind(SecretOperationErrorKind? errorKind)
    {
        return errorKind switch
        {
            SecretOperationErrorKind.NotFound => Severity.Warning,
            SecretOperationErrorKind.AccessDenied => Severity.Error,
            SecretOperationErrorKind.ConnectionFailed => Severity.Error,
            SecretOperationErrorKind.NotSupported => Severity.Info,
            SecretOperationErrorKind.InvalidKey => Severity.Warning,
            _ => Severity.Error
        };
    }

    private void ToggleAddSecretForm()
    {
        _showAddSecretForm = !_showAddSecretForm;
        if (!_showAddSecretForm)
        {
            ClearAddSecretForm();
        }
    }

    private void CancelAddSecret()
    {
        _showAddSecretForm = false;
        ClearAddSecretForm();
    }

    private void ClearAddSecretForm()
    {
        _newSecretKey = string.Empty;
        _newSecretValue = string.Empty;
    }

    private async Task SaveSecret()
    {
        if (string.IsNullOrWhiteSpace(_newSecretKey) || string.IsNullOrWhiteSpace(_newSecretValue))
        {
            return;
        }

        if (SecretManagerState.CurrentManager is not ISecretWriter writer)
        {
            _statusMessage = "Current manager does not support writing secrets.";
            _alertSeverity = Severity.Warning;
            return;
        }

        _isSaving = true;
        _statusMessage = null;
        StateHasChanged();

        var result = await writer.SetSecretAsync(_newSecretKey, _newSecretValue);

        if (result.Success)
        {
            _statusMessage = $"Secret '{_newSecretKey}' saved successfully.";
            _alertSeverity = Severity.Success;
            _showAddSecretForm = false;
            ClearAddSecretForm();

            // Refresh the list if manager supports it
            if (SecretManagerState.CanSearch())
            {
                await RefreshSecrets();
            }
        }
        else
        {
            _statusMessage = result.ErrorMessage ?? "Failed to save secret.";
            _alertSeverity = GetSeverityForErrorKind(result.ErrorKind);
        }

        _isSaving = false;
        StateHasChanged();
    }

    private void ToggleGetSecretForm()
    {
        _showGetSecretForm = !_showGetSecretForm;
        if (!_showGetSecretForm)
        {
            ClearGetSecretForm();
        }
    }

    private void CancelGetSecret()
    {
        _showGetSecretForm = false;
        ClearGetSecretForm();
    }

    private void ClearGetSecretForm()
    {
        _getSecretKey = string.Empty;
        _retrievedSecret = null;
    }

    private async Task GetSecret()
    {
        if (string.IsNullOrWhiteSpace(_getSecretKey))
        {
            return;
        }

        if (SecretManagerState.CurrentManager == null)
        {
            _statusMessage = "No secret manager is active.";
            _alertSeverity = Severity.Warning;
            return;
        }

        _isGetting = true;
        _statusMessage = null;
        _retrievedSecret = null;
        StateHasChanged();

        var result = await SecretManagerState.GetSecretAsync(_getSecretKey);

        if (result.Success && result.Value != null)
        {
            _retrievedSecret = result.Value;
            _statusMessage = $"Secret '{_getSecretKey}' retrieved successfully.";
            _alertSeverity = Severity.Success;
        }
        else
        {
            _statusMessage = result.ErrorMessage ?? $"Secret '{_getSecretKey}' not found.";
            _alertSeverity = GetSeverityForErrorKind(result.ErrorKind);
        }

        _isGetting = false;
        StateHasChanged();
    }

    private void Close()
    {
        MudDialog?.Close();
    }

    public void Dispose()
    {
        SecretManagerState.StateChanged -= OnStateChanged;
    }
}

