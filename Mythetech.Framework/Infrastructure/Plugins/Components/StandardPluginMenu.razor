@using MudBlazor
@using Microsoft.AspNetCore.Components
@using Mythetech.Framework.Infrastructure.Files
@using Mythetech.Framework.Infrastructure.Guards
@using Mythetech.Framework.Components.Buttons
@inject PluginState PluginState
@inject PluginLoader PluginLoader
@inject IFileOpenService FileOpenService
@inject IDialogService DialogService
@inject PluginContext PluginContext
@inject IShowFileService ShowFileService
@implements IDisposable

<MudMenu ActivationEvent="@ActivationEvent" 
         AnchorOrigin="@AnchorOrigin" 
         TransformOrigin="@TransformOrigin"
         Dense="@Dense" 
         ListClass="@ListClass">
    <ActivatorContent>
        <Button Size="@ButtonSize" Variant="@ButtonVariant" Color="@ButtonColor" Class="@ButtonClass" Text="@MenuText" />
    </ActivatorContent>
    <ChildContent>
        @{
            var plugins = PluginState.Plugins.ToList();
        }
        @foreach (var plugin in plugins)
        {
            <MudMenu ActivationEvent="MouseEvent.MouseOver"
                     AnchorOrigin="Origin.TopRight"
                     TransformOrigin="Origin.TopLeft"
                     Dense="@Dense"
                     Label="@plugin.Manifest?.Name"
                     StartIcon="@(plugin.Manifest?.Icon ?? PluginIcons.DefaultPluginIcon)"
                     ListClass="@ListClass">
                
                    @foreach (var menuType in plugin.MenuComponents)
                    {
                        <PluginMenuItemsRenderer MenuType="@menuType" ItemClass="@ItemClass" PluginContext="@PluginContext" />
                    }
                    
                    @if (plugin.MenuComponents.Any())
                    {
                        <MudDivider />
                    }
                    
                    <MudMenuItem Class="@ItemClass" 
                                Icon="@Icons.Material.Filled.Info" 
                                OnClick="() => HandleAboutPlugin(plugin)">
                        About...
                    </MudMenuItem>
                    <MudMenuItem Class="@ItemClass" 
                                Icon="@(plugin.IsEnabled ? Icons.Material.Filled.Block : Icons.Material.Filled.CheckCircle)" 
                                OnClick="() => HandleDisablePlugin(plugin)">
                        @(plugin.IsEnabled ? "Disable" : "Enable")
                    </MudMenuItem>
                    <MudMenuItem Class="@ItemClass" 
                                Icon="@Icons.Material.Filled.Delete" 
                                OnClick="() => HandleDeletePlugin(plugin)">
                        Delete...
                    </MudMenuItem>
            </MudMenu>
        }
        
        @if (plugins.Any())
        {
            <MudDivider />
        }
        
        <MudMenuItem Class="@ItemClass" Icon="@Icons.Material.Filled.Apps" OnClick="HandleViewPlugins">
            View Plugins
        </MudMenuItem>

        <DesktopOnly>
            <MudMenuItem Class="@ItemClass"
                         Icon="@Icons.Custom.Uncategorized.FolderOpen"
                         OnClick="HandleOpenDirectory"
                         Disabled="@(string.IsNullOrEmpty(PluginState.PluginDirectory))">
                Open Directory
            </MudMenuItem>
        </DesktopOnly>

        <MudDivider />
        
        <MudMenuItem Class="@ItemClass" Icon="@Icons.Material.Filled.FileUpload" OnClick="HandleImportPlugin">
            Import Plugin...
        </MudMenuItem>
        <MudMenuItem Class="@ItemClass" Icon="@Icons.Material.Filled.Link" OnClick="HandleImportPluginFromUrl">
            Import from URL...
        </MudMenuItem>
    </ChildContent>
</MudMenu>

@code {
    [Parameter] public string MenuText { get; set; } = "Plugins";
    [Parameter] public MouseEvent ActivationEvent { get; set; } = MouseEvent.MouseOver;
    [Parameter] public Origin AnchorOrigin { get; set; } = Origin.BottomLeft;
    [Parameter] public Origin TransformOrigin { get; set; } = Origin.TopLeft;
    [Parameter] public bool Dense { get; set; } = true;
    [Parameter] public string ListClass { get; set; } = "pa-1";
    [Parameter] public string ItemClass { get; set; } = "rounded";
    [Parameter] public Size ButtonSize { get; set; } = Size.Small;
    [Parameter] public Variant ButtonVariant { get; set; } = Variant.Text;
    [Parameter] public Color ButtonColor { get; set; } = Color.Inherit;
    [Parameter] public string ButtonClass { get; set; } = "text-transform-none";

    protected override void OnInitialized()
    {
        PluginState.StateChanged += OnStateChanged;
    }

    private void OnStateChanged(object? sender, EventArgs e)
    {
        InvokeAsync(StateHasChanged).ContinueWith(t =>
        {
            if (t.IsFaulted && t.Exception != null)
            {
                Console.Error.WriteLine($"Error in OnStateChanged: {t.Exception}");
            }
        }, TaskScheduler.Default);
    }

    private async Task HandleAboutPlugin(PluginInfo plugin)
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };
        
        var parameters = new DialogParameters
        {
            { "Plugin", plugin }
        };
        
        await DialogService.ShowAsync<AboutPluginDialog>($"About {plugin.Manifest.Name}", parameters, options);
    }
    
    private async Task HandleDisablePlugin(PluginInfo plugin)
    {
        if (plugin.IsEnabled)
        {
            await PluginState.DisablePluginAsync(plugin.Manifest.Id);
        }
        else
        {
            await PluginState.EnablePluginAsync(plugin.Manifest.Id);
        }
    }

    private async Task HandleDeletePlugin(PluginInfo plugin)
    {
        var result = await DialogService.ShowMessageBox(
            title: "Delete Plugin",
            message: $"Are you sure you want to delete '{plugin.Manifest.Name}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            await PluginState.RemovePluginAsync(plugin.Manifest.Id);
        }
    }

    private async Task HandleImportPlugin()
    {
        var files = await FileOpenService.OpenFileAsync(
            title: "Select Plugin DLL",
            filters: [new FileFilter("Plugin DLLs", ["*.dll"])]);

        if (files.Length == 0) return;

        foreach (var dllPath in files)
        {
            var pluginInfo = PluginLoader.LoadPlugin(dllPath);
            if (pluginInfo is not null)
            {
                await PluginState.RegisterPluginAsync(pluginInfo);
            }
        }
    }
    
    private async Task HandleImportPluginFromUrl()
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };
        
        await DialogService.ShowAsync<DefaultPluginUrlLoadDialog>("Import Plugin from URL", options);
    }
    
    private async Task HandleViewPlugins()
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        await DialogService.ShowAsync<PluginManagementDialog>("Plugin Management", options);
    }

    private async Task HandleOpenDirectory()
    {
        if (!string.IsNullOrEmpty(PluginState.PluginDirectory))
        {
            await ShowFileService.ShowFolderAsync(PluginState.PluginDirectory);
        }
    }

    public void Dispose()
    {
        PluginState.StateChanged -= OnStateChanged;
    }
}
