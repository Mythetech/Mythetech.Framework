@using MudBlazor
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Options
@using Mythetech.Framework.Infrastructure.Mcp.Server
@using Mythetech.Framework.Components.Switch
@using Mythetech.Framework.Components.Buttons
@inject McpServerState McpState
@inject IOptions<McpServerOptions> Options
@implements IDisposable

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Api" />
            <MudText Typo="Typo.h6">MCP Server Info</MudText>
            @if (McpState.IsRunning)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">Running</MudChip>
            }
            else
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">Stopped</MudChip>
            }
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.subtitle1" Class="mb-2">Connection</MudText>
        <MudStack Spacing="1" Class="mb-4">
            <MudStack Row="true" Spacing="2">
                <MudText Typo="Typo.body2" Color="Color.Secondary" Style="min-width: 80px;">Transport:</MudText>
                <MudText Typo="Typo.body2">@TransportType</MudText>
            </MudStack>
            @if (IsHttpTransport)
            {
                <MudStack Row="true" Spacing="2">
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Style="min-width: 80px;">Endpoint:</MudText>
                    <MudText Typo="Typo.body2"><code>@(McpState.HttpEndpoint ?? "Not started")</code></MudText>
                </MudStack>
            }
            else
            {
                <MudStack Row="true" Spacing="2">
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Style="min-width: 80px;">Command:</MudText>
                    <MudText Typo="Typo.body2"><code>@ExecutablePath --mcp</code></MudText>
                </MudStack>
            }
            <MudStack Row="true" Spacing="2">
                <MudText Typo="Typo.body2" Color="Color.Secondary" Style="min-width: 80px;">Server:</MudText>
                <MudText Typo="Typo.body2">@Options.Value.ServerName v@(Options.Value.ServerVersion ?? "1.0.0")</MudText>
            </MudStack>
        </MudStack>

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.subtitle1" Class="mb-2">Registered Tools (@McpState.RegisteredTools.Count)</MudText>

        @if (McpState.RegisteredTools.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                No tools registered. Add tools using AddMcpTools() or AddMcpTool&lt;T&gt;().
            </MudAlert>
        }
        else
        {
            <MudList T="McpToolDescriptor" Dense="true">
                @foreach (var tool in McpState.RegisteredTools)
                {
                    <MudListItem T="McpToolDescriptor">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="width: 100%;">
                            <MudStack Spacing="0">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Small" Color="@(McpState.IsToolEnabled(tool.Name) ? Color.Primary : Color.Default)" />
                                    <MudText Typo="Typo.body1" Style="@(McpState.IsToolEnabled(tool.Name) ? "" : "opacity: 0.5;")"><code>@tool.Name</code></MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="ml-6" Style="@(McpState.IsToolEnabled(tool.Name) ? "" : "opacity: 0.5;")">
                                    @tool.Description
                                </MudText>
                                @if (tool.InputType is not null)
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Tertiary" Class="ml-6" Style="@(McpState.IsToolEnabled(tool.Name) ? "" : "opacity: 0.5;")">
                                        Input: @tool.InputType.Name
                                    </MudText>
                                }
                            </MudStack>
                            <Switch T="bool"
                                       Value="@McpState.IsToolEnabled(tool.Name)"
                                       ValueChanged="@(async v => await McpState.SetToolEnabledAsync(tool.Name, v))"
                                       Color="Color.Primary"
                                       Size="Size.Small" />
                        </MudStack>
                    </MudListItem>
                }
            </MudList>
        }
    </DialogContent>
    <DialogActions>
        <Button Text="Close" OnClick="Close" Variant="Variant.Text" />
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance? MudDialog { get; set; }

    private string ExecutablePath => System.Environment.ProcessPath ?? "app";

    private bool IsHttpTransport => McpState.HttpEndpoint != null || Options.Value.HttpEnabled;

    private string TransportType => IsHttpTransport ? "http" : "stdio";

    protected override void OnInitialized()
    {
        McpState.StateChanged += OnStateChanged;
    }

    private void OnStateChanged(object? sender, EventArgs e)
    {
        InvokeAsync(StateHasChanged).ContinueWith(t =>
        {
            if (t.IsFaulted && t.Exception != null)
            {
                Console.Error.WriteLine($"Error in OnStateChanged: {t.Exception}");
            }
        }, TaskScheduler.Default);
    }

    private void Close()
    {
        MudDialog?.Close();
    }

    public void Dispose()
    {
        McpState.StateChanged -= OnStateChanged;
    }
}
