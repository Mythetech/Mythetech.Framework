@using MudBlazor
@using System.Diagnostics
@using System.Runtime.Versioning
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Options
@using Mythetech.Framework.Infrastructure.MessageBus
@using Mythetech.Framework.Infrastructure.Mcp.Messages
@using Mythetech.Framework.Infrastructure.Mcp.Server
@inject McpServerState McpState
@inject IMessageBus MessageBus
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IOptions<McpServerOptions> Options
@implements IDisposable

<MudMenu ActivationEvent="MouseEvent.MouseOver"
         AnchorOrigin="Origin.TopRight"
         TransformOrigin="Origin.TopLeft"
         Dense="true"
         Label="@MenuLabel"
         StartIcon="@Icons.Material.Filled.Api"
         ListClass="pa-1">
    <MudMenuItem Class="rounded"
                 Icon="@(McpState.IsRunning ? Icons.Material.Filled.Stop : Icons.Material.Filled.PlayArrow)"
                 OnClick="HandleToggleServer">
        @(McpState.IsRunning ? "Disable" : "Enable")
    </MudMenuItem>

    <MudMenuItem Class="rounded"
                 Icon="@Icons.Material.Filled.Terminal"
                 Disabled="@(!McpState.IsRunning || string.IsNullOrEmpty(McpState.HttpEndpoint))"
                 OnClick="HandleAddToClaudeCode">
        Add to Claude Code
    </MudMenuItem>

    <MudMenuItem Class="rounded"
                 Icon="@Icons.Material.Filled.Info"
                 OnClick="HandleShowInfo">
        Info...
    </MudMenuItem>
</MudMenu>

@code {
    private string MenuLabel => McpState.IsRunning ? "MCP Server â€¢" : "MCP Server";

    protected override void OnInitialized()
    {
        McpState.StateChanged += OnStateChanged;
    }

    private void OnStateChanged(object? sender, EventArgs e)
    {
        InvokeAsync(StateHasChanged).ContinueWith(t =>
        {
            if (t.IsFaulted && t.Exception != null)
            {
                Console.Error.WriteLine($"Error in OnStateChanged: {t.Exception}");
            }
        }, TaskScheduler.Default);
    }

    private async Task HandleToggleServer()
    {
        if (McpState.IsRunning)
        {
            await MessageBus.PublishAsync(new DisableMcpServerMessage());
        }
        else
        {
            await MessageBus.PublishAsync(new EnableMcpServerMessage());
        }
    }

    [UnsupportedOSPlatform("browser")]
    private async Task HandleAddToClaudeCode()
    {
        if (string.IsNullOrEmpty(McpState.HttpEndpoint))
        {
            Snackbar.Add("MCP server is not running", Severity.Warning);
            return;
        }

        var serverName = Options.Value.ServerName.ToLowerInvariant().Replace(" ", "-");
        var endpoint = McpState.HttpEndpoint;

        try
        {
            var startInfo = new ProcessStartInfo
            {
                FileName = "claude",
                Arguments = $"mcp add --transport http {serverName} {endpoint}",
                RedirectStandardOutput = true,
                RedirectStandardError = true,
                UseShellExecute = false,
                CreateNoWindow = true
            };

            using var process = Process.Start(startInfo);
            if (process is null)
            {
                Snackbar.Add("Failed to start claude CLI", Severity.Error);
                return;
            }

            await process.WaitForExitAsync();

            if (process.ExitCode == 0)
            {
                Snackbar.Add($"Added '{serverName}' to Claude Code at {endpoint}", Severity.Success);
            }
            else
            {
                var error = await process.StandardError.ReadToEndAsync();
                Snackbar.Add($"Failed to add to Claude Code: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}. Is 'claude' CLI installed?", Severity.Error);
        }
    }

    private async Task HandleShowInfo()
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        await DialogService.ShowAsync<McpInfoDialog>("MCP Server Info", options);
    }

    public void Dispose()
    {
        McpState.StateChanged -= OnStateChanged;
    }
}
